<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Kana Master</title>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="images/icon-192.png">
<meta name="theme-color" content="#0066ff" />

<style>
/* CSS Variables */
:root{
  --bg: #f5f7fb;
  --card: #ffffff;
  --text: #111827;
  --muted: #6b7280;
  --accent: #0066ff;
  --button-bg: #0066ff;
  --button-text: #ffffff;
  --tab-active: #0066ff;
  --border-color: rgba(0,0,0,0.08);
}
[data-theme="dark"]{
  --bg: #0b1220;
  --card: #071127;
  --text: #e6eef8;
  --muted: #9aa7bb;
  --accent: #3390ff;
  --button-bg: #1a6cff;
  --button-text: #fff;
  --tab-active: #1a6cff;
  --border-color: rgba(255,255,255,0.1);
}

/* Global/Reset */
html,body{height:100%; margin:0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased;}
.app {
  min-height:100vh;
  display:flex;
  flex-direction:column;
  align-items:center;
  padding:12px;
  box-sizing:border-box;
}

/* Card container */
.card{
  width:100%;
  max-width:520px;
  background:var(--card);
  border-radius:18px; /* Slightly larger radius for mobile feel */
  box-shadow: 0 10px 30px rgba(2,6,23,0.1);
  padding:16px; /* Slightly more padding */
  box-sizing:border-box;
  display:flex;
  flex-direction:column;
  gap:12px;
}

/* Header */
.header {
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
  padding:4px 0;
}
.title { font-size:20px; font-weight:700; }
.controls { display:flex; gap:8px; align-items:center; }

/* Tabs */
.tabs {
  display:flex;
  padding: 4px;
  gap:8px;
  justify-content:center;
  background: var(--bg);
  border-radius: 12px;
}
.tab {
  flex:1;
  text-align:center;
  padding:8px 8px;
  border-radius:8px;
  background:transparent;
  font-weight:600;
  cursor:pointer;
  user-select:none;
  transition: all 0.2s ease-in-out;
}
.tab.active {
  background:var(--tab-active);
  color:white;
  box-shadow:0 4px 12px rgba(0,102,255,0.3);
}

/* Question & Answer */
.q-area {
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:6px;
  padding:10px;
}
#question {
  font-size:48px; /* Larger question */
  font-weight:700;
  letter-spacing:1px;
  margin-top:6px;
}
#answer {
  font-size:40px;
  color:var(--muted);
  min-height: 48px; /* Keep space for answer */
  display:none;
}

/* Big Controls (Buttons) */
.actions {
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  justify-content:center;
  margin-top:4px;
}
.btn {
  flex: 1 1 45%; /* Better flex for two buttons per row */
  padding:14px 10px;
  border-radius:12px;
  border:none;
  font-size:16px;
  font-weight:700;
  background:var(--button-bg);
  color:var(--button-text);
  cursor:pointer;
  transition: background 0.2s;
}
.btn.secondary { background:var(--card); color:var(--text); border:1px solid var(--border-color); }
.btn.small { flex: 0 0 auto; font-size:14px; padding:8px 12px; }

/* Drawing Area */
.canvas-wrap {
  width:100%;
  display:flex;
  justify-content:center;
  margin-top:8px;
}
canvas#draw {
  width:100%;
  height:40vh; /* Responsive height */
  max-height:400px;
  background:var(--bg);
  border-radius:12px;
  border:1px solid var(--border-color);
  touch-action:none;
  box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
}

/* Footer small */
.footer {
  margin-top:10px;
  font-size:12px;
  color:var(--muted);
  text-align:center;
  padding-bottom:10px;
}

/* Responsive tweaks */
@media(min-width:720px){
  #question{ font-size:64px; }
  #answer{ font-size:56px; }
  .btn{ font-size:18px; }
  canvas#draw { max-height:500px; height: 50vh;}
}
</style>
</head>
<body>
<div class="app" id="app">
  <div class="card" role="application">
    <div class="header">
      <div class="title">Kana Master</div>
      <div class="controls">
        <button id="darkToggle" class="btn small secondary" title="Toggle dark mode">ðŸŒ™</button>
        <button id="speakBtn" class="btn small secondary" title="Play pronunciation">ðŸ”Š</button>
      </div>
    </div>

    <div class="tabs" role="tablist" aria-label="Practice mode">
      <div class="tab active" data-mode="hiragana">Hiragana</div>
      <div class="tab" data-mode="katakana">Katakana</div>
      <div class="tab" data-mode="both">Both</div>
    </div>

    <div class="q-area">
      <div id="question">Tap Next</div>
      <div id="answer" aria-live="polite"></div>
    </div>

    <div class="actions" aria-hidden="false">
      <button id="nextBtn" class="btn">Next Kana</button>
      <button id="showBtn" class="btn secondary">Show Answer</button>
      <button id="clearBtn" class="btn secondary">Clear Drawing</button>
    </div>

    <div class="canvas-wrap">
      <canvas id="draw" aria-label="Drawing area for kana practice"></canvas>
    </div>

    <div class="footer">Practice by writing in the box. Audio uses your device's Japanese voice.</div>
  </div>
</div>

<script>
/* ---------- Kana data (comprehensive) ---------- */

// helper to create pairs quickly
function pairs(list){ return list.map(x=>[x[0], x[1]]); }

const hiraganaList = pairs([
  ['a','ã‚'],['i','ã„'],['u','ã†'],['e','ãˆ'],['o','ãŠ'],
  ['ka','ã‹'],['ki','ã'],['ku','ã'],['ke','ã‘'],['ko','ã“'],
  ['sa','ã•'],['shi','ã—'],['su','ã™'],['se','ã›'],['so','ã'],
  ['ta','ãŸ'],['chi','ã¡'],['tsu','ã¤'],['te','ã¦'],['to','ã¨'],
  ['na','ãª'],['ni','ã«'],['nu','ã¬'],['ne','ã­'],['no','ã®'],
  ['ha','ã¯'],['hi','ã²'],['fu','ãµ'],['he','ã¸'],['ho','ã»'],
  ['ma','ã¾'],['mi','ã¿'],['mu','ã‚€'],['me','ã‚'],['mo','ã‚‚'],
  ['ya','ã‚„'],['yu','ã‚†'],['yo','ã‚ˆ'],
  ['ra','ã‚‰'],['ri','ã‚Š'],['ru','ã‚‹'],['re','ã‚Œ'],['ro','ã‚'],
  ['wa','ã‚'],['wo','ã‚’'],['n','ã‚“'],
  // dakuten (voiced)
  ['ga','ãŒ'],['gi','ãŽ'],['gu','ã'],['ge','ã’'],['go','ã”'],
  ['za','ã–'],['ji','ã˜'],['zu','ãš'],['ze','ãœ'],['zo','ãž'],
  ['da','ã '],['di','ã¢'],['du','ã¥'],['de','ã§'],['do','ã©'],
  ['ba','ã°'],['bi','ã³'],['bu','ã¶'],['be','ã¹'],['bo','ã¼'],
  // handakuten (p)
  ['pa','ã±'],['pi','ã´'],['pu','ã·'],['pe','ãº'],['po','ã½'],
  // contracted (small kana combos)
  ['kya','ãã‚ƒ'],['kyu','ãã‚…'],['kyo','ãã‚‡'],
  ['sha','ã—ã‚ƒ'],['shu','ã—ã‚…'],['sho','ã—ã‚‡'],
  ['cha','ã¡ã‚ƒ'],['chu','ã¡ã‚…'],['cho','ã¡ã‚‡'],
  ['nya','ã«ã‚ƒ'],['nyu','ã«ã‚…'],['nyo','ã«ã‚‡'],
  ['hya','ã²ã‚ƒ'],['hyu','ã²ã‚…'],['hyo','ã²ã‚‡'],
  ['mya','ã¿ã‚ƒ'],['myu','ã¿ã‚…'],['myo','ã¿ã‚‡'],
  ['rya','ã‚Šã‚ƒ'],['ryu','ã‚Šã‚…'],['ryo','ã‚Šã‚‡'],
  ['gya','ãŽã‚ƒ'],['gyu','ãŽã‚…'],['gyo','ãŽã‚‡'],
  ['bya','ã³ã‚ƒ'],['byu','ã³ã‚…'],['byo','ã³ã‚‡'],
  ['pya','ã´ã‚ƒ'],['pyu','ã´ã‚…'],['pyo','ã´ã‚‡'],
  ['ja','ã˜ã‚ƒ'],['ju','ã˜ã‚…'],['jo','ã˜ã‚‡'],
  // small kana standalone
  ['small-ya','ã‚ƒ'],['small-yu','ã‚…'],['small-yo','ã‚‡'],['small-tsu','ã£']
]);

const katakanaList = pairs([
  ['a','ã‚¢'],['i','ã‚¤'],['u','ã‚¦'],['e','ã‚¨'],['o','ã‚ª'],
  ['ka','ã‚«'],['ki','ã‚­'],['ku','ã‚¯'],['ke','ã‚±'],['ko','ã‚³'],
  ['sa','ã‚µ'],['shi','ã‚·'],['su','ã‚¹'],['se','ã‚»'],['so','ã‚½'],
  ['ta','ã‚¿'],['chi','ãƒ'],['tsu','ãƒ„'],['te','ãƒ†'],['to','ãƒˆ'],
  ['na','ãƒŠ'],['ni','ãƒ‹'],['nu','ãƒŒ'],['ne','ãƒ'],['no','ãƒŽ'],
  ['ha','ãƒ'],['hi','ãƒ’'],['fu','ãƒ•'],['he','ãƒ˜'],['ho','ãƒ›'],
  ['ma','ãƒž'],['mi','ãƒŸ'],['mu','ãƒ '],['me','ãƒ¡'],['mo','ãƒ¢'],
  ['ya','ãƒ¤'],['yu','ãƒ¦'],['yo','ãƒ¨'],
  ['ra','ãƒ©'],['ri','ãƒª'],['ru','ãƒ«'],['re','ãƒ¬'],['ro','ãƒ­'],
  ['wa','ãƒ¯'],['wo','ãƒ²'],['n','ãƒ³'],
  ['ga','ã‚¬'],['gi','ã‚®'],['gu','ã‚°'],['ge','ã‚²'],['go','ã‚´'],
  ['za','ã‚¶'],['ji','ã‚¸'],['zu','ã‚º'],['ze','ã‚¼'],['zo','ã‚¾'],
  ['da','ãƒ€'],['di','ãƒ‚'],['du','ãƒ…'],['de','ãƒ‡'],['do','ãƒ‰'],
  ['ba','ãƒ'],['bi','ãƒ“'],['bu','ãƒ–'],['be','ãƒ™'],['bo','ãƒœ'],
  ['pa','ãƒ‘'],['pi','ãƒ”'],['pu','ãƒ—'],['pe','ãƒš'],['po','ãƒ'],
  ['kya','ã‚­ãƒ£'],['kyu','ã‚­ãƒ¥'],['kyo','ã‚­ãƒ§'],
  ['sha','ã‚·ãƒ£'],['shu','ã‚·ãƒ¥'],['sho','ã‚·ãƒ§'],
  ['cha','ãƒãƒ£'],['chu','ãƒãƒ¥'],['cho','ãƒãƒ§'],
  ['nya','ãƒ‹ãƒ£'],['nyu','ãƒ‹ãƒ¥'],['nyo','ãƒ‹ãƒ§'],
  ['hya','ãƒ’ãƒ£'],['hyu','ãƒ’ãƒ¥'],['hyo','ãƒ’ãƒ§'],
  ['mya','ãƒŸãƒ£'],['myu','ãƒŸãƒ¥'],['myo','ãƒŸãƒ§'],
  ['rya','ãƒªãƒ£'],['ryu','ãƒªãƒ¥'],['ryo','ãƒªãƒ§'],
  ['gya','ã‚®ãƒ£'],['gyu','ã‚®ãƒ¥'],['gyo','ã‚®ãƒ§'],
  ['bya','ãƒ“ãƒ£'],['byu','ãƒ“ãƒ¥'],['byo','ãƒ“ãƒ§'],
  ['pya','ãƒ”ãƒ£'],['pyu','ãƒ”ãƒ¥'],['pyo','ãƒ”ãƒ§'],
  ['ja','ã‚¸ãƒ£'],['ju','ã‚¸ãƒ¥'],['jo','ã‚¸ãƒ§'],
  ['small-ya','ãƒ£'],['small-yu','ãƒ¥'],['small-yo','ãƒ§'],['small-tsu','ãƒƒ']
]);

/* app state */
let currentMode = 'hiragana';
let currentPool = hiraganaList.slice();
let current = null;

/* DOM refs */
const tabs = document.querySelectorAll('.tab');
const qEl = document.getElementById('question');
const aEl = document.getElementById('answer');
const showBtn = document.getElementById('showBtn');
const nextBtn = document.getElementById('nextBtn');
const clearBtn = document.getElementById('clearBtn');
const darkToggle = document.getElementById('darkToggle');
const speakBtn = document.getElementById('speakBtn');

/* =========== Dark mode (persist) =========== */
function loadTheme(){
  const t = localStorage.getItem('kana-theme') || 'light';
  if(t === 'dark') document.documentElement.setAttribute('data-theme','dark');
  else document.documentElement.setAttribute('data-theme','light');
}
function toggleTheme(){
  const cur = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
  const next = cur === 'dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', next);
  localStorage.setItem('kana-theme', next);
  // Re-run resize to update stroke style with new theme
  resizeCanvas(); 
}
darkToggle.addEventListener('click', toggleTheme);


/* =========== Tabs =========== */
tabs.forEach(t => t.addEventListener('click', () => {
  const mode = t.dataset.mode || t.innerText.toLowerCase();
  setMode(mode);
}));

function setMode(mode){
  currentMode = mode;
  tabs.forEach(t => t.classList.toggle('active', t.dataset.mode === mode));
  if(mode === 'hiragana') currentPool = hiraganaList.slice();
  else if(mode === 'katakana') currentPool = katakanaList.slice();
  else currentPool = hiraganaList.concat(katakanaList);
  nextQuestion();
}

/* =========== Quiz logic =========== */
function nextQuestion(){
  if(!currentPool || currentPool.length === 0) return;
  // Use a temporary array to ensure we don't pick the same item twice in a row
  let newKana;
  do {
    newKana = currentPool[Math.floor(Math.random()*currentPool.length)];
  } while(current && newKana[0] === current[0]); // Simple check to avoid repetition
  
  current = newKana;
  qEl.textContent = current[0];
  aEl.style.display = 'none';
  aEl.textContent = '';
  clearCanvas();
}
function showAnswer(){
  if(!current) return;
  if(currentMode === 'both'){
    const h = hiraganaList.find(x=>x[0] === current[0]);
    const k = katakanaList.find(x=>x[0] === current[0]);
    aEl.textContent = `${h ? h[1] : ''} / ${k ? k[1] : ''}`;
  } else {
    aEl.textContent = current[1];
  }
  aEl.style.display = 'block';
}

showBtn.addEventListener('click', showAnswer);
nextBtn.addEventListener('click', nextQuestion);

/* =========== Audio Pronunciation (Web Speech API) =========== */
function speakCurrent(){
  if(!current) return;
  let textToSpeak;
  if(currentMode === 'katakana') {
      textToSpeak = (katakanaList.find(x=>x[0]===current[0]) || [null,''])[1];
  } else {
      // Prioritize Hiragana for sound, as it is native Japanese script.
      textToSpeak = (hiraganaList.find(x=>x[0]===current[0]) || [null,''])[1];
  }

  // Fallback to the current character if the lookup fails for some reason
  if(!textToSpeak) textToSpeak = current[1]; 
  
  if('speechSynthesis' in window){
    const u = new SpeechSynthesisUtterance(textToSpeak);
    u.lang = 'ja-JP';
    u.rate = 0.8; // Slightly slower rate for learning
    window.speechSynthesis.cancel(); // stop previous
    window.speechSynthesis.speak(u);
  } else {
    alert('Speech synthesis is not supported in this browser or device.');
  }
}
speakBtn.addEventListener('click', speakCurrent);

/* =========== Drawing canvas (hi-dpi) =========== */
const canvas = document.getElementById('draw');
const ctx = canvas.getContext('2d');

function resizeCanvas(){
  const ratio = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  canvas.width = Math.round(rect.width * ratio);
  canvas.height = Math.round(rect.height * ratio);
  ctx.scale(ratio, ratio);
  // Re-apply styles after scale
  ctx.strokeStyle = window.getComputedStyle(document.documentElement).getPropertyValue('--text').trim() || '#111827';
  ctx.lineWidth = 10; // Slightly thicker line for mobile touch
  ctx.lineCap = 'round';
  ctx.lineJoin = 'round';
  clearCanvas(); // Clear when resizing
}

window.addEventListener('resize', resizeCanvas);

let drawing = false;
function getPointerPos(e){
  const rect = canvas.getBoundingClientRect();
  if(e.touches && e.touches.length) {
    return {x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top};
  }
  return {x: e.clientX - rect.left, y: e.clientY - rect.top};
}

canvas.addEventListener('pointerdown', (e) => {
  drawing = true;
  const p = getPointerPos(e);
  ctx.beginPath();
  ctx.moveTo(p.x, p.y);
  // This prevents scrolling/zoom on touch devices
  e.preventDefault(); 
}, {passive: false});

canvas.addEventListener('pointermove', (e) => {
  if(!drawing) return;
  const p = getPointerPos(e);
  ctx.lineTo(p.x, p.y);
  ctx.stroke();
});
canvas.addEventListener('pointerup', ()=> drawing = false);
canvas.addEventListener('pointercancel', ()=> drawing = false);
canvas.addEventListener('mouseleave', ()=> drawing = false); // stop drawing if pointer leaves canvas

function clearCanvas(){
  const rect = canvas.getBoundingClientRect();
  const ratio = window.devicePixelRatio || 1;
  ctx.clearRect(0,0, rect.width * ratio, rect.height * ratio);
  resizeCanvas(); // Re-set drawing context when clearing (important for theme switch)
}

/* wire clear button */
clearBtn.addEventListener('click', clearCanvas);

/* PWA service worker registration */
function registerSW(){
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('sw.js')
      .then(() => console.log('Service Worker Registered'))
      .catch((error) => console.log('Service Worker registration failed:', error));
  }
}

/* initialize app */
loadTheme();
registerSW();
// Initial setup must be done after theme/resize to get correct colors
window.addEventListener('load', () => { 
  resizeCanvas(); 
  setMode('hiragana');
}); 

</script>
</body>
</html>